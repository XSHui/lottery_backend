# 线上征文抽奖活动设计文档

## 一、设计目标

### 1.1 活动背景

为了庆祝业务周年，需要举行一个线上征文活动


### 1.2 活动内容

* 用户需要在页面用户填写手机号码报名（需要验证码校验，一个手机号只能报名一次），并上传一段500字以内的文本。
* 成功的用户可以在页面参与抽奖，每天可以抽一次
* 需要提取所有报名用户的手机号码和对应的征文内容
* 需要导出所有获奖记录


### 1.3 奖池内容

```
    物品    数量    规则
    手机    5部     每天限制产出1部，概率1%
    电话卡  100张   每个用户活动期间内最多获得2张，概率5%
    贴纸    不限量  概率94%
```

### 1.4 开发信息

* 发送验证码无需实现，定义空函数即可
* 开发语言不限但建议使用go/php
* 存储可用redis或mysql
* 前端使用javascript进行请求并根据返回结果进行渲染
* 代码建议提交到git.code.tencent.com或其他git仓库并提供可读权限


## 二、整体框架


## 三、前端（TODO）


## 四、后端

### 2.1 后端业务


### 2.2 DB设计(mysql)

**瓶颈/难点**:

- 热点问题，抽奖活动会集中在奖品表的部分数据上，db设计不当会产生热点问题进而成为系统瓶颈

- 写写冲突问题，如果db的事务模型为乐观锁模式(tidb-v3.0.8之前默认为乐观锁)，则乐观事务冲突则会导致整个系统性能下降

**解决方案**:
1. 热点问题
- Redis缓存解决
- db侧将数据打散
- 请求拦截

2. 写写冲突问题
- Tidb开启悲观锁模式
- Redis分布式锁
- MySql 
- 消息队列，要求业务允许异步执行
- 减小事务粒度

> table: user
```
id: 电话号码
name:
```

> table: lottery
```
user_id: 用户id
activity_id: 活动id
lottery_idx: 当前活动总抽奖次数
prize_id: 奖品id
daily_count: 当前活动当天抽奖次数
last_time: 当前活动最后一次抽奖时间
```

> table: article
```
user_id: 用户id，电话号码
activity_id: 活动场次
modify_time: 修改时间
writings: 用户提交的短文(默认:多次提交，覆盖)
```

> table: prize
```
id: 奖品id
activity_id: 活动场次id
name: 奖品名称
count: 奖品数量
probability: 获奖概率
remaining_count: 奖品剩余数量
```

> table: activity
```
id: 活动场次
name: 活动名称
start_time: 活动开始时间
end_time: 活动结束时间
```